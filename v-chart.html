<!--
@license
Vaadin Charts

Copyright (C) 2015 Vaadin Ltd

This program is available under Commercial Vaadin Add-On License 3.0 (CVALv3).

See the file LICENSE.md distributed with this software for more information about licensing.

See <a href="https://vaadin.com/license/cval-3">the website</a> for the complete license.
-->
<script src="../highcharts/adapters/standalone-framework.js"></script>
<script src="../highcharts/highcharts.js"></script>
<script src="../highcharts/highcharts-more.js"></script>
<script src="../highcharts/highcharts-3d.js"></script>
<script src="../highcharts/modules/heatmap.js"></script>
<script src="../highcharts/modules/treemap.js"></script>
<script src="../highcharts/modules/drilldown.js"></script>
<script src="../highcharts/modules/data.js"></script>
<script src="../highcharts/modules/exporting.js"></script>
<script src="../highcharts/modules/funnel.js"></script>
<script src="../highcharts/modules/solid-gauge.js"></script>
<script src="../highcharts/modules/data.js"></script>
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="v-series.html">
<link rel="import" href="valo-theme.html">
<link rel="import" href="configuration-reader.html">

<!--
An element that provides a WebComponent interface for <a href="http://www.highcharts.com/">HighCharts</a>

Example:

    <v-chart type="line">
        <vc-title>Example</vc-title>
        <v-series name="Example">
            <vc-data>["Example1", 45.0], ["Example2", 26.8]</vc-data>
        </v-series>
    </v-chart>
-->
<dom-module id="v-chart">
    <template>
        <div id="chartContainer" style="height:100%; width:100%;"></div>
    </template>
    <script>
        Polymer({
            is: 'v-chart',

            behaviors: [ValoThemeBehavior, ConfigurationReaderBehavior],

            /**
             * Fired when the chart has been fully loaded.
             *
             * @event chart-loaded
             */

            properties: {

                /**
                 * Highcharts JS object. Use this to configure the chart after creation.
                 **/
                chart: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                type: {
                    type: String,
                    value: 'line'
                },

                initialized: {
                    type: Boolean,
                    value: false
                },

                /* ----------- internal ----------- */

                /**
                 * Initial chart configuration before initial rendering.
                 **/
                _chartConf: {
                    type: Object,
                    value: function () {
                        return {chart: {}};
                    }
                }
            },


            /**
             * Reloads the chart with the original configuration defined in elements and its attributes.
             */
            reloadConfiguration: function () {
                this._chartConf = {chart: {}};
                this._initConfiguration();
                this.chart.destroy();
                this.chart = {};
                this._reloadSeries();
                this._initChart();
            },

            /**
             * Reload all the chart's series
             */
            _reloadSeries: function () {
                var series = Polymer.dom(this).querySelectorAll('v-series');
                for (var i = 0; i < series.length; i++) {
                    series[i]._reloadConfiguration();
                }
            },

            /**
             * Dynamically add a new Series to this chart
             * @return The index of the added series in the series array
             **/
            _addSeries: function (newSeries) {
                if (this._chartConf.series === undefined) {
                    this._chartConf.series = [];
                }
                this._chartConf.series.push(newSeries);
                return this._chartConf.series.length - 1;
            },

            /**
             * Dynamically add a new Series to this chart's Drilldown configuration
             * @return The index of the added series in the drilldown series array
             **/
            _addDrilldownSeries: function (newSeries) {
                if (!this._chartConf.drilldown) {
                    this._chartConf.drilldown = {};
                }
                if (!this._chartConf.drilldown.series) {
                    this._chartConf.drilldown.series = [];
                }
                this._chartConf.drilldown.series.push(newSeries);
                return this._chartConf.drilldown.series.length - 1;
            },

            /* ----------- lifecycle ----------- */
            created: function () {
                //Workaround to prevent _chartConf from being undefined when calling _addSeries from child component in FF
                this._chartConf = {};
            },

            attached: function () {
                this._initChart();
            },

            /**
             * Initializes the chart property using the json configuration.
             */
            _initChart: function () {
                //Only initialize once
                if (Object.keys(this.chart).length === 0) {
                    this.chart = new Highcharts.Chart(this._chartConf);
                    this.initialized = true;
                    this.fire("chart-loaded");
                }
            },

            ready: function () {
                this._initConfiguration();

                if (this._loadTheme) {
                    this._loadTheme();
                }
            },

            /**
             * Initializes the chart json configuration.
             */
            _initConfiguration: function () {
                this._cleanNode(Polymer.dom(this));
                this._loadConfiguration(this._chartConf, Polymer.dom(this));

                if (!this._chartConf.chart) {
                    this._chartConf.chart = {};
                }

                this._chartConf.chart.type = this.type;
                this._chartConf.chart.renderTo = this.$.chartContainer;
            }
        });
    </script>
</dom-module>
