<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="v-cval-check.html">
<link rel="import" href="../../iron-pages/iron-pages.html">
<link rel="import" href="../../paper-tabs/paper-tabs.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="../v-chart.html">

<!--
This component allows viewing demo HTML files, so that the actual demo and the source are shown different pages. The file name, without the ".html" suffix, should be passed to the "source" property. The loaded DOM is inserted directly into the demo page, while the HTML text is loaded into the source page (using iron-ajax).
-->

<dom-module id="sourcing-component">
    <style>
        :host .sourcecode {
            cursor: text;
            padding-left: 20px;
            -moz-user-select: text;
            -webkit-user-select: text;
            -ms-user-select: text;
        }
    </style>
    <template>
        <iron-ajax
                id="sourceFetcher"
                auto
                handle-as="text"
                last-response="{{htmlValue}}"
                debounce-duration="300"></iron-ajax>

        <paper-tabs id="tabs" selected="{{selected}}">
            <paper-tab>Example</paper-tab>
            <paper-tab>Source</paper-tab>
        </paper-tabs>

        <iron-pages id="pages" selected="{{selected}}">
            <div id="page1"></div>
            <pre id="page2" class="sourcecode">{{htmlValue}}</pre>
        </iron-pages>
    </template>
</dom-module>

<script>
    (function () {
        var demoId2dom = {};
        Polymer({
            is: "sourcing-component",

            properties: {
                selected: {
                    type: String,
                    value: '0'
                },

                source: {
                    type: String,
                    observer: '_sourceChanged'
                },

                htmlValue: String
            },

            updateDemo: function (demoId, oldDemoId) {
                if (demoId2dom[demoId]) {
                    // Clear example tab
                    var pageNode = Polymer.dom(this.$.page1)

                    var oldChildren = Array.prototype.slice.call(pageNode.childNodes);
                    for (var i = 0; i < oldChildren.length; i++) {
                        var childNode = oldChildren[i];
                        if (childNode.nodeType == Node.ELEMENT_NODE) {
                            demoId2dom[oldDemoId].appendChild(pageNode.removeChild(childNode));
                        }
                    }

                    // Add the DOM from cache
                    var newChildren = Array.prototype.slice.call(demoId2dom[demoId].childNodes);
                    for (var i = 0; i < newChildren.length; i++) {
                        var childNode = newChildren[i];
                        if (childNode.nodeType == Node.ELEMENT_NODE) {
                            pageNode.appendChild(childNode);
                        }
                    }

                    // Load source code into tab two
                    this.$.sourceFetcher.url = demoId + ".html";
                }
            }
            ,

            _sourceChanged: function (newValue, oldValue) {
                if (demoId2dom[newValue]) {
                    this.updateDemo(newValue, oldValue);
                }
                else {
                    this.importHref(newValue + ".html", function (result) {
                        demoId2dom[newValue] = result.target.import.body;
                        this.updateDemo(newValue, oldValue);
                    });
                }
            }
        });
    })();
</script>
