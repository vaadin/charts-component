<!doctype html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-chart tests</title>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../vaadin-chart.html">
</head>

<body>
  <dom-module id="element-api-chart-series-value-labels-test">
    <template>
      <vaadin-chart id="mychart">
        <vaadin-chart-series id="myseries" values="{{values}}" value-labels="{{labels}}"></vaadin-chart-series>
      </vaadin-chart>
    </template>

    <script>
      HTMLImports.whenReady(() => {
        class ChartSeriesApiValueLabelsTestElement extends Polymer.Element {
          static get is() {
            return 'element-api-chart-series-value-labels-test';
          }

          static get properties() {
            return {
              values: {
                type: Array,
                value: [10, 20, 10, 30, 50]
              },
              labels: {
                type: Array
              }
            };
          }
        }

        customElements.define(ChartSeriesApiValueLabelsTestElement.is, ChartSeriesApiValueLabelsTestElement);
      });
    </script>
  </dom-module>
  <test-fixture id="default">
    <template>
      <element-api-chart-series-value-labels-test></element-api-chart-series-value-labels-test>
    </template>
  </test-fixture>

  <script>
    describe('High-level Charts Series Value Labels API', function() {
      let element;
      let chart;
      let series;

      beforeEach(function(done) {
        HTMLImports.whenReady(() => {
          element = fixture('default');
          chart = element.$.mychart;
          series = element.$.myseries;
          setTimeout(function() {
            done();
          }, 100);
        });
      });

      it('should have values (array of numbers) as labels by default', function(done) {
        setTimeout(() => {
          const firstSeries = chart.configuration.series[0];
          const actual = firstSeries.data.map(e => e.name);

          expect(element.values).to.deep.equal(actual);
          done();
        }, 50);
      });

      it('should have values (array of arrays where both elements are numbers) as labels by default', function(done) {
        const valuesArrayArray = [[10, 20], [40, 50], [70, 80]];
        element.values = valuesArrayArray;
        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          const actual = firstSeries.data.map(e => [e.x, e.name]);

          expect(valuesArrayArray).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should have values (array of arrays where the first element is a string) as labels by default', function(done) {
        const valuesArrayArray = [['Lagos', 20], ['Rio', 50], ['Montevideo', 80]];
        element.values = valuesArrayArray;
        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          const actual = firstSeries.data.map(e => [e.name, e.y, e.x]);

          const expected = valuesArrayArray.slice();
          expected.map((e, index) => e.push(index));
          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should have values (array of objects) as labels by default', function(done) {
        const valuesObjectArray = [{name: '10', y: 20}, {name: '40', y: 50}, {name: '70', y: 80}];
        element.values = valuesObjectArray;
        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          const expected = valuesObjectArray.map(e => [e.name, e.y]);
          const actual = firstSeries.data.map(e => [e.name, e.y]);

          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should accept labels as mapping object for values (array of numbers)', function(done) {
        const labelsAsObject = {10: 'Mon', 20: 'Tue', 30: 'Wed', 50: 'Thur'};
        element.labels = labelsAsObject;

        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];

          // When the first argument is a string, it is taken as the name
          // Highcharts assigns serial values for missing x starting from 0
          const expected = element.values.map(e => labelsAsObject[e] || e);
          const actual = firstSeries.data.map(e => e.name);

          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should accept labels as mapping object for values (array of arrays)', function(done) {
        const valuesArrayArray = [['Vaadin', 90], ['Flow', 30], [10, 20], [40, 50], [70, 80]];
        element.values = valuesArrayArray;

        const labelsAsObject = {10: 'Mon', 20: 'Tue', 30: 'Wed', 50: 'Thur'};
        element.labels = labelsAsObject;

        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          const expected = [[0, 'Vaadin'], [1, 'Wed'], [10, 'Tue'], [40, 'Thur'], [70, 80]];
          const actual = firstSeries.data.map(e => [e.x, e.name]);

          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should accept labels as mapping object for values (array of objects)', function(done) {
        const valuesObjectArray = [{name: '10', x: 1, y: 20}, {name: '40', x: 2, y: 50}, {y: 100}];
        element.values = valuesObjectArray;

        const labelsAsObject = {10: 'Mon', 20: 'Tue', 30: 'Wed', 50: 'Thur'};
        element.labels = labelsAsObject;

        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];

          // We pick the mapping, if absent the name, if absent the value.
          // The last x was intentionally left off in the test input
          // Highcharts assigns serial values for missing x starting from 0
          const expected = element.values.map(e => [e.x || 0, labelsAsObject[e.y] || e.name || e.y]);
          const actual = firstSeries.data.map(e => [e.x, e.name]);

          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should accept labels as mapping object string', function(done) {
        const labelsAsObject = {10: 'Mon', 20: 'Tue', 30: 'Wed', 50: 'Thur'};
        const labelsAsObjectString = JSON.stringify(labelsAsObject);
        series.setAttribute('value-labels', labelsAsObjectString);

        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          expect(firstSeries.data.map(e => e.name)).to.deep.equal(
            firstSeries.data.map(e => labelsAsObject[e.y] || e.y));
          done();
        }, 70);
      });

      it('should accept labels as function for values (array of numbers)', function(done) {
        const labelsAsFunction = e => e + 'AAA';
        element.labels = labelsAsFunction;

        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          const expected = element.values.map(e => e + 'AAA');
          const actual = firstSeries.data.map(e => e.name);

          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should accept labels as function for values (array of arrays)', function(done) {
        const valuesArrayArray = [[10, 20], [40, 50], [70, 80]];
        element.values = valuesArrayArray;

        const labelsAsFunction = e => e + 'AAA';
        element.labels = labelsAsFunction;

        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          const expected = element.values.map(e => [e[0], e[1] + 'AAA']);
          const actual = firstSeries.data.map(e => [e.x, e.name]);

          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should accept labels as function for values (array of objects)', function(done) {
        const valuesObjectArray = [{name: '10', x: 1, y: 20}, {name: '40', x: 2, y: 50}, {x: 7, y: 100}];
        element.values = valuesObjectArray;

        const labelsAsFunction = e => e + 'AAA';
        element.labels = labelsAsFunction;

        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          const expected = element.values.map(e => [e.x, e.y + 'AAA']);
          const actual = firstSeries.data.map(e => [e.x, e.name]);

          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should accept labels as function string', function(done) {
        const labelsAsFunctionString = 'function(e) { return e + "BBB"; }';
        series.setAttribute('value-labels', labelsAsFunctionString);
        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          expect(firstSeries.data.map(e => e.name)).to.deep.equal(
            firstSeries.data.map(e => e.y + 'BBB'));
          done();
        }, 70);
      });

      it('should accept labels as array for values (array of numbers)', function(done) {
        const labelsAsArray = ['Mon', 'Tue', 'Wed', 'Thur', 'Fri'];
        element.labels = labelsAsArray;

        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          const expected = labelsAsArray;
          const actual = firstSeries.data.map(e => e.name);

          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should accept labels as array for values (array of arrays)', function(done) {
        const valuesArrayArray = [[10, 20], [40, 50], [70, 80]];
        element.values = valuesArrayArray;

        const labelsAsArray = ['Mon', 'Tue', 'Wed', 'Thur', 'Fri'];
        element.labels = labelsAsArray;

        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          // We pick the mapping, if absent the value
          const expected = element.values.map((e, index) => [e[0], labelsAsArray[index] || e[1]]);
          const actual = firstSeries.data.map(e => [e.x, e.name]);

          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should accept labels as array for values (array of objects)', function(done) {
        const valuesObjectArray = [{name: '10', x: 1, y: 20}, {name: '40', x: 2, y: 50}, {name: 'Vaadin', x: 7, y: 100}, {x: 7, y: 100}];
        element.values = valuesObjectArray;

        const labelsAsArray = ['Mon', 'Tue'];
        element.labels = labelsAsArray;

        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          // We pick the mapping, if absent the name, if absent the value
          const expected = element.values.map((e, index) => [e.x, labelsAsArray[index] || e.name || e.y]);
          const actual = firstSeries.data.map(e => [e.x, e.name]);

          expect(expected).to.deep.equal(actual);
          done();
        }, 70);
      });

      it('should accept labels as array string', function(done) {
        const labelsAsArray = ['Mon', 'Tue', 'Wed', 'Thur', 'Fri'];
        const labelsAsArrayString = JSON.stringify(labelsAsArray);
        series.setAttribute('value-labels', labelsAsArrayString);
        setTimeout(function() {
          const firstSeries = chart.configuration.series[0];
          expect(firstSeries.data.map(e => e.name)).to.deep.equal(labelsAsArray);
          done();
        }, 70);
      });
    });
  </script>
</body>
